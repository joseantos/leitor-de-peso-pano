<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leitor de Peso</title>
  <style>
    /* Existing CSS */
  </style>
</head>
<body>
  <!-- Existing HTML -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script>
    if (typeof window !== 'undefined' && typeof document !== 'undefined') {
      let pesos = [];
      let scannerAtivo = false;

      const pesoLista = document.getElementById('peso-lista');
      const pesoTotal = document.getElementById('peso-total');
      const quantidade = document.getElementById('quantidade');
      const startStopButton = document.getElementById('start-stop-button');
      const manualInput = document.getElementById('manual-input');
      const addManualButton = document.getElementById('add-manual-button');
      const clearListButton = document.getElementById('clear-list-button');

      function atualizarLista() {
        pesoLista.innerHTML = '';
        let total = 0;
        pesos.forEach(p => {
          total += p;
          const li = document.createElement('li');
          li.textContent = p.toFixed(3) + ' kg';
          pesoLista.appendChild(li);
        });
        pesoTotal.textContent = total.toFixed(3);
        quantidade.textContent = pesos.length;
      }

      function vibrateIfSupported(duration) {
        if ('vibrate' in navigator) {
          navigator.vibrate(duration);
        }
      }

      function tocarSom() {
        const beep = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        beep.play().catch(error => console.error('Erro ao reproduzir som:', error));
      }

      function adicionarPeso(valor) {
        let peso = parseFloat(valor);
        if (!isNaN(peso) && peso > 0) {
          pesos.push(peso);
          vibrateIfSupported(200);
          tocarSom();
          atualizarLista();
        }
      }

      function adicionarPesoHandler(e) {
        e.preventDefault();
        adicionarPeso(manualInput.value);
        manualInput.value = '';
      }

      const isTouchDevice = 'ontouchstart' in window;
      const eventType = isTouchDevice ? 'touchstart' : 'click';

      startStopButton.addEventListener(eventType, (e) => {
        e.preventDefault();
        iniciarScanner();
      });

      addManualButton.addEventListener(eventType, adicionarPesoHandler);
      clearListButton.addEventListener(eventType, (e) => {
        e.preventDefault();
        pesos = [];
        atualizarLista();
      });

      manualInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarPeso(manualInput.value);
          manualInput.value = '';
        }
      });

      function iniciarScanner() {
        if (scannerAtivo) return;
        Quagga.init({
          inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#scanner'),
            constraints: { facingMode: "environment" }
          },
          decoder: { readers: ["ean_reader", "code_128_reader"] }
        }, function(err) {
          if (err) {
            console.error('Quagga init error:', err);
            alert('Erro ao acessar a câmera: ' + err.message);
            return;
          }
          Quagga.start();
          scannerAtivo = true;
          document.getElementById('scanner').style.display = 'block';
          startStopButton.textContent = 'Fechar Câmera';
        });

        Quagga.onDetected((data) => {
          if (data && data.codeResult && data.codeResult.code) {
            adicionarPeso(data.codeResult.code);
            pararScanner();
          }
        });
      }

      function pararScanner() {
        Quagga.stop();
        scannerAtivo = false;
        document.getElementById('scanner').style.display = 'none';
        startStopButton.textContent = 'Ler Código';
      }
    } else {
      console.log('This script requires a browser environment.');
    }
  </script>
</body>
</html>
